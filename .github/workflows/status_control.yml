name: æ‰‹å‹•ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
on:
  issues:
    types: [opened]
jobs:
  update-status:
    # ãƒ©ãƒ™ãƒ« `update_status` ãŒä»˜ã„ãŸ Issue ã®ã¿å®Ÿè¡Œ
    if: contains(github.event.issue.labels.*.name, 'update_status')
    runs-on: [self-hosted, windows]
    steps:
      - uses: actions/checkout@v3

      - name: çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ï¼†JSONå‡ºåŠ›
        shell: powershell
        run: |
          $hosts = @(
            @{ name='PC1'; ip='192.168.1.101'; mac='AA:BB:CC:DD:EE:FF' }
            @{ name='PC2'; ip='192.168.1.102'; mac='11:22:33:44:55:66' }
          )
          $results = foreach ($h in $hosts) {
            $alive = Test-Connection -Count 1 -Quiet -ComputerName $h.ip
            [PSCustomObject]@{ name=$h.name; ip=$h.ip; mac=$h.mac; alive=$alive }
          }
          $results | ConvertTo-Json -Depth 2 | Out-File -Encoding utf8 docs/status.json

      - name: ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥
        shell: powershell
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs/status.json
          if (-not (git diff --cached --quiet)) {
            git commit -m "ğŸ“¡ manual update status.json"
            git push
          }

      - name: Issue Close
        uses: actions-ecosystem/action-close-issue@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          comment: 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ãŒå®Œäº†ã—ã¾ã—ãŸã€‚'
